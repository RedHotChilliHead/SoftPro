# SoftPro

Проект позволяет получать, хранить и отдавать некие коэффициенты (линии) для трёх видов спорта: бейсбола, американского футбола и футбола.

## Компоненты

### 1. Lines Provider
Представлен в виде публичного образа antonboom/lines-provider. Он предоставляет API для получения коэффициентов (линий) для различных видов спорта.
С помощью определенных эндпоинтов позволяет получать коэффициенты (линии).

#### Эндпоинт:
```http
http://localhost:8000/api/v1/lines/<sport>/
```
Вместо <sport> должен быть указан один из следующих видов спорта: "baseball", "football" или "soccer".

### 2. Kiddy Line Processor
Сервис, написанный на Python, предоставляет два API с разной реализацией: HTTP и gRPC. 
Он отвечает за получение данных от Lines Provider и их обработку.

### 3. Хранилище для Kiddy Line Processor
Данные сохраняются в PostgreSQL, где для каждого спорта создается отдельная таблица.

## Алгоритм работы сервиса Kiddy Line Processor

При запуске приложение инициирует воркеры для каждого вида спорта, которые работают в "фоновом" режиме и выполняют следующие задачи:
1. **Получение данных**: Периодически (раз в N секунд) отправляется запрос к Lines Provider для получения последних коэффициентов для каждого вида спорта.
2. **Сохранение данных**: Полученные данные сохраняются в соответствующих таблицах PostgreSQL.
3. **Запуск gRPC-сервера**: Сервер запускается и начинает слушать порт 50051.
4. **Обработка запросов клиента**: При поступлении запроса от клиента с перечнем интересующих видов спорта и интервалом обновления, воркеры переключаются на обработку запроса клиента.
5. **Отправка данных клиенту**: gRPC-сервер отправляет обновленные данные в соответствии с указанным интервалом до тех пор, пока клиент не отключится.

**Примечание**: Возможна настройка индивидуального интервала N для каждого спорта для указания частоты синхронизации линий с базой данных.

### HTTP API

#### Эндпоинт:

```http
http://127.0.0.1:8080/ready/
```
Этот эндпоинт используется для проверки соединения с хранилищем и выполнения первой синхронизации линий.

Ответы:
- 200: {"status": "ready"} — соединение с хранилищем установлено, первая синхронизация линий выполнена.
- 503: {"status": "not ready"} — нет соединения с хранилищем или не выполнена первая синхронизация линий.

### gRPC API

#### Эндпоинт:

```
/SubscribeOnSportsLines
```
Этот метод позволяет клиентам подписываться на обновления линий для указанных видов спорта 
через полнодуплексный (bidirectional streaming RPC) канал.
На порт 50051 должен быть передан список спортов и с какой периодичностью клиент хочет получать линии в секундах.
В первом ответе будут направлены линии по указанным спортам, в последующих - дельты от предыдущих полных значений.

#### Пример запроса

```plaintext
/SubscribeOnSportsLines [soccer, football] 3s
```
Здесь [soccer, football] — виды спорта, 3s — интервал обновлений в секундах.

#### Пример ответа

```plaintext
INFO:root:Received sports lines: {'football': 2.71, 'soccer': 2.17}
INFO:root:Received sports lines: {'football': -2.31, 'soccer': -1.26}
INFO:root:Received sports lines: {'football': 1.54, 'soccer': -0.01}
```

## Список параметров конфигурации приложения:

- **Адрес HTTP сервера** http://127.0.0.1:8080/
- **Адрес GRPC сервера** http://127.0.0.1:50051/
- **Адрес Lines Provider** http://127.0.0.1:8000/
- **Адрес базы данных PostgreSQL** http://127.0.0.1:54322/
- **Интервал N синхронизации с Lines Provider**: по умолчанию 60 секунд для каждого вида спорта
- **Уровень логирования**: "INFO"

## Установка и запуск

Для развертывания всей необходимой инфраструктуры используйте Docker и Docker Compose.

### Предварительные требования

- Убедитесь, что у вас установлены Docker и Docker Compose
- Версия Python: 3.11

### Шаги установки

1. Клонируйте репозиторий проекта:

```
git clone https://github.com/RedHotChilliHead/SoftPro.git
cd SoftPro
```
2. Установите зависимости:
```
pip install -r requirements.txt
```
3. Соберите и запустите Docker-контейнеры:
```
make run
```
Это создаст необходимые тома, соберет и запустит Docker-контейнеры в фоновом режиме и выполнит миграции.

4. Запустите gRPC клиент:
```
cd soft_pro/grpsapp
python grpc_client.py
```
Значения будут сохранены в базе данных, и клиент будет получать обновленные коэффициенты.

Для остановки клиента нажмите Ctrl+C.

5. Остановите сервисы:
```
make stop
```
## Тестирование

Тесты включают юнит-тесты для проверки работы API и интеграционные тесты для взаимодействия с базой данных.

- Запуск тестов:
```
make test
```

- Запуск статического анализа кода:
```
make lint
```

### CI-пайплайн

Проект имеет настроенный CI-пайплайн с использованием GitHub Actions. При каждом "push" или "pull_request" 
будут запущены тесты и статический анализ кода.